{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash

set -ex

command_exists() {
  command -v "$@" >/dev/null 2>&1
}

is_wsl() {
    [ -n "${WSL_DISTRO_NAME:-}" ] || grep -qi 'microsoft\|wsl' /proc/version 2>/dev/null
}

main() {
  echo "ğŸš€ Installing development tools..."

  # Volta
  echo ""
  echo "ğŸ“¦ Installing Volta..."
  if ! command_exists volta; then
    echo "Installing Volta Node.js manager..."
    curl https://get.volta.sh | bash -s -- --skip-setup

    # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§Voltaã‚’æœ‰åŠ¹åŒ–
    export VOLTA_HOME="$HOME/.volta"
    export PATH="$VOLTA_HOME/bin:$PATH"

    echo "âœ… Volta installed successfully"
  else
    echo "âœ… Volta already installed, skipping"
  fi

  # Node.JS
  echo ""
  echo "ğŸ“¦ Installing Node.js tools..."
  if command_exists volta; then
    echo "Installing Node.js via Volta..."
    volta install node@lts
    volta install npm@latest
    volta install yarn@latest
    echo "âœ… Node.js tools installed successfully"
  else
    echo "âŒ volta command not found, skipping Node.js installation"
  fi

  # Docker
  echo ""
  echo "ğŸ³ Installing Docker..."
  if ! command_exists docker; then
    echo "Installing Docker Engine..."

    # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    sudo apt update
    sudo apt install -y ca-certificates curl gnupg lsb-release

    # Dockerå…¬å¼GPGã‚­ãƒ¼ã®è¿½åŠ 
    sudo mkdir -m 0755 -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    sudo chmod a+r /etc/apt/keyrings/docker.gpg

    # Dockerãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    # Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’dockerã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
    sudo usermod -aG docker "$USER"

    # WSLå›ºæœ‰ã®è¨­å®š
    if is_wsl; then
      echo "ğŸ§ Configuring Docker for WSL..."
      if ! grep -q "systemd=true" /etc/wsl.conf 2>/dev/null; then
        echo -e "[boot]\nsystemd=true" | sudo tee -a /etc/wsl.conf
        echo "âš ï¸  WSL systemd enabled. Please restart WSL to apply changes:"
        echo "   wsl --shutdown"
      fi
    fi

    echo "âœ… Docker installed successfully"
    echo "âš ï¸  Please log out and log back in to use Docker without sudo"

  else
    echo "âœ… Docker already installed, skipping"
  fi

  # Brew Install
  echo ""
  echo "ğŸ“¦ Installing Brew packages..."
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  brew bundle --file=Brewfile_wsl

  # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
  echo ""
  echo "ğŸ‰ Installation completed!"
  echo "Installed tools:"
}

main "$@"

{{- end -}}
